---
title: "Mother/Infant Metabolome & Microbiome Analysis"
subtitle: "INOVA Data Set"
author: "Dan Kerchner"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r}
#devtools::install_github("himelmallick/Tweedieverse")
library(Tweedieverse)
#devtools::install_version("statmod", version = "1.4.33", repos ="http://cran.us.r-project.org")
#devtools::install_version("cplm", version = "0.7-12", repos = "http://cran.us.r-project.org")
#devtools::install_github('omicsEye/omicsArt', force = TRUE)
library(tibble)
library(dplyr)
library(tidyr)
library(readr)
library(Tweedieverse)
library(ggplot2)
library(omicsArt)
library(cowplot)
library(vegan)
library(ggcorrplot)
library(gt)
library(gtsummary)
#library(Maaslin2)
```

# Load data 
```{r}
metadata_infant_raw_df <- read.csv('data/cleaned/infant_metadata_v2.csv')
metadata_mother_raw_df <- read.csv('data/cleaned/mother_metadata_v2.csv')

metabolite_infant_df <- read.delim('data/infant_metabolite.txt',
                            check.names = TRUE) # Repair column names
microbiome_infant_df <- read.delim('data/infant_microbiome.tsv',
                            check.names = TRUE) # Repair column names
microbiome_mother_df <- read.delim('data/breastmilk_microbiome.tsv',
                            check.names = TRUE) # Repair column names
```
# How many observations per External_ID?

```{r}
obs_counts <- metadata_infant_raw_df %>%
  count(External_ID) %>%
  rename(n_count = n)

at_least_df <- data.frame()
for (i in 1:4) {
  at_least_row <- data.frame(n = i, n_at_least = sum(obs_counts$n_count >= i))
  at_least_df <- rbind(at_least_df, at_least_row)
}

ggplot(at_least_df) +
  geom_col(aes(y= n_at_least, x = n))

```

# Reformat data frames 

```{r}
metadata_infant_df <- metadata_infant_raw_df
metadata_mother_df <- metadata_mother_raw_df
colnames(metadata_mother_df) <- paste0('mother_', colnames(metadata_mother_df))
metadata_mother_df <- metadata_mother_df %>% # rename BACK to External_ID (no mother_)
  rename(External_ID = mother_External_ID)

# Repair BMI category

# BMI.category needs repair.  Use this:
# 0) underweight (BMI < 18.5), 1) normal (BMI 18.5 - 24.9), 2) obese (BMI 25 - 29.9), 3) morbid obese (BMI >30)

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_BMI.category = case_when(#mother_BMI < 18.5 ~ "underweight",
                                         mother_BMI < 25 ~ "Underweight/Normal",
                                         mother_BMI < 30 ~ "Overweight",
                                         mother_BMI >= 30 ~ "Obese",
                                         TRUE ~ as.character(NA)))

metadata_mother_df$mother_BMI.category <- factor(metadata_mother_df$mother_BMI.category,
                                        levels = c("Underweight/Normal", "Overweight", "Obese"),
                                        labels = c("Underweight/Normal", "Overweight", "Obese"))

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_BMI.overweight = as.integer(metadata_mother_df$mother_BMI.category == "Overweight"),
         mother_BMI.obese = as.integer(metadata_mother_df$mother_BMI.category == "Obese"))

metadata_mother_df$mother_GDM <- factor(metadata_mother_df$mother_GDM,
                                        levels = c('No', 'Yes'),
                                        labels = c('No', 'Yes'))

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_Method.of.delivery = if_else(mother_Method.of.delivery =="No",
                                             "Vaginal", "C-Section"))

metadata_mother_df$mother_Method.of.delivery <- factor(metadata_mother_df$mother_Method.of.delivery,
                                                       levels = c("Vaginal", "C-Section"),
                                                       labels = c("Vaginal", "C-Section"))



metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_Age.category = if_else(mother_Age < 35, 'Under 35', '35 and over'))

metadata_mother_df$mother_Age.category = factor(metadata_mother_df$mother_Age.category,
                                                levels = c('Under 35', '35 and over'),
                                                labels = c('Under 35', '35 and over'))

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_Race = if_else(mother_Race %in% c("More than one race", "Other"),
                               "Other",
                               mother_Race))

metadata_mother_df$mother_Race <- 
  factor(metadata_mother_df$mother_Race,
         levels = c("1", "3", "2", "Other", ""),
         labels = c("White/Caucasian", "Black/African-American",
                    "Asian", 
                    "Other", "Unknown"))

metadata_mother_df$mother_Maternal.smoking <-
  factor(metadata_mother_df$mother_Maternal.smoking,
         levels = c("2", "1"),
         labels = c("Never Smoked",
                    "Smoked before pregnancy"))

metadata_infant_df <- metadata_infant_df %>%
  mutate(Gestational_age_at_birth_weeks_exact =
           Gestational_age_at_birth_week + Gestational_age_at_birth_day/7)

metadata_infant_df$Infant_diet_at_age_of_breastmilk_sample_obtained <-
  factor(metadata_infant_df$Infant_diet_at_age_of_breastmilk_sample_obtained,
         levels = c(0, 1, 2, 5, 6, 7),
         labels = c("Exclusively mother's breast milk (MBM)", "Mother's breast milk fortified with formula",
                    "Exclusively donor breast milk (DBM)" ,"Mother's breast milk and donor breast milk",
                    "Donor milk fortified with formula",
                    "MBM + DBM + Fortified"))

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_Parity_before = mother_Parity..after.delivery. - 1)

metadata_all_df <- left_join(metadata_infant_df, metadata_mother_df)

# Set to TRUE to take only the first sample from each child
EXCLUDE_MULTI_SAMPLES <- FALSE

if (EXCLUDE_MULTI_SAMPLES) {
  metadata_infant_df <- metadata_infant_df %>%
    filter(!endsWith(Sample_ID, 'b')) %>%
    filter(!endsWith(Sample_ID, 'c')) %>%
    filter(!endsWith(Sample_ID, 'd'))
}


# Fix metadata IDs

metadata_all_df <- metadata_all_df %>%
  mutate(Sample_ID = paste0('X', Sample_ID))

rownames(metadata_all_df) <- metadata_all_df$Sample_ID
metadata_all_df <- metadata_all_df %>%
  select(-Sample_ID)

# Fix omics IDs
clean_names <- make.names(metabolite_infant_df$X)
metabolite_name_ref <- data.frame(clean_name = clean_names, metabolite_name = metabolite_infant_df$X)

rownames(metabolite_infant_df) <- make.names(metabolite_infant_df$X)
metabolite_infant_df <- metabolite_infant_df %>%
  select(-X)

rownames(microbiome_infant_df) <- microbiome_infant_df$X
microbiome_infant_df <- microbiome_infant_df %>%
  select(-X)

rownames(microbiome_mother_df) <- microbiome_mother_df$X
microbiome_mother_df <- microbiome_mother_df %>%
  select(-X)

```

# Correlations among GDM and confounders

## BMI Category

```{r}
gdm_bmi_cat_tab <- table(metadata_mother_df$mother_BMI.category,
                         metadata_mother_df$mother_GDM)
gdm_bmi_cat_tab
chisq.test(gdm_bmi_cat_tab)  
```
```{r}
gdm_bmi_model <- glm(mother_GDM ~ mother_BMI.category, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_bmi_model)

# convert to confidence interval to show that our study is very underpowered
```
## Age

```{r}
gdm_age_model <- glm(mother_GDM ~ mother_Age, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_age_model)

# convert to categories
metadata_mother_df %>%
  ggplot() +
  geom_histogram(aes(x = mother_Age),
                 binwidth = 1, color = 'white')

metadata_mother_df <- metadata_mother_df %>%
  mutate(mother_Age.category = case_when(mother_Age < 30 ~ "under 30",
                                       mother_Age >= 30 ~ "30+",
                                       TRUE ~ as.character(NA)))

table(metadata_mother_df$mother_Age.category, metadata_mother_df$mother_GDM, useNA = 'always')

gdm_age_model2 <- glm(mother_GDM ~ mother_Age.category, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_age_model2)
# Do confidence interval for OR
```
## Smoking

```{r}
gdm_smoking_tab <- table(metadata_mother_df$mother_Maternal.smoking,
                         metadata_mother_df$mother_GDM)
gdm_smoking_tab
chisq.test(gdm_smoking_tab)  
```
```{r}
gdm_smoking_model <- glm(mother_GDM ~ mother_Maternal.smoking, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_smoking_model)

# convert to confidence interval to show that our study is very underpowered
```
## Hypertension

```{r}
gdm_htn_tab <- table(htn = metadata_mother_df$mother_Hypertensive.Disorder..PIH..preeclampsia..HELLP.,
                         gdm = metadata_mother_df$mother_GDM)
gdm_htn_tab
chisq.test(gdm_htn_tab)  

```
```{r}
gdm_htn_model <- glm(mother_GDM ~ mother_Hypertensive.Disorder..PIH..preeclampsia..HELLP., data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_htn_model)

# convert to confidence interval to show that our study is very underpowered
```
## Gravidity

```{r}
gdm_gravidity_model <- glm(mother_GDM ~ mother_Gravidity, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_gravidity_model)

```
## Parity

```{r}
gdm_parity_model <- glm(mother_GDM ~ mother_Parity_before, data = metadata_mother_df,
                     family = 'binomial')
summary(gdm_parity_model)

```

## Gender of child

```{r}
# Need to make a temporary df
gender_gdm_df <- left_join(metadata_mother_df %>% select(External_ID, mother_GDM),
                           metadata_infant_df %>% select(External_ID, Gender_of_child))

gdm_gender_tab <- table(gender = gender_gdm_df$Gender_of_child,
                        gdm = gender_gdm_df$mother_GDM)
gdm_gender_tab
chisq.test(gdm_gender_tab)  
```
```{r}
gdm_gender_model <- glm(mother_GDM ~ Gender_of_child, data = gender_gdm_df,
                     family = 'binomial')
summary(gdm_gender_model)

# convert to confidence interval to show that our study is very underpowered
```


# Table 1

```{r}
metadata_single_df <- metadata_all_df %>%
  select(External_ID, mother_Age.category,
         mother_BMI.category, mother_GDM,
         mother_Maternal.smoking, mother_Race,
         #mother_Ethnicity,
         mother_Parity_before,
         mother_HDP = mother_Hypertensive.Disorder..PIH..preeclampsia..HELLP.,
         mother_Abx.use.post.partum,
         mother_Vitamins.Supplements.during.pregnancy,
         mother_Parity..after.delivery.,
         mother_Method.of.delivery,
         Gender_of_child, 
         #Infant_diet = Infant_diet_at_age_of_breastmilk_sample_obtained,
         Gestational_age_at_birth_week) %>%
  distinct()

table1 <- metadata_single_df %>%
  tbl_summary(include = c(mother_Age.category, mother_BMI.category,
                          mother_Maternal.smoking, mother_Race,
                          #mother_Ethnicity,
                          mother_Parity_before, mother_HDP, mother_Abx.use.post.partum,
                          mother_Vitamins.Supplements.during.pregnancy,
                          mother_Method.of.delivery,
                          Gender_of_child, #Infant_diet,
                          Gestational_age_at_birth_week),
              by = c(mother_GDM),
              label = c(mother_Age.category = "Age (mother)",
                        mother_BMI.category = "BMI (mother)",
                        mother_Maternal.smoking = "Smoking",
                        mother_Race = "Race (mother)",
                        mother_Parity_before = "Parity",
                        mother_Vitamins.Supplements.during.pregnancy = "Prenatal vitamin supplements",
                        mother_Method.of.delivery = "Method of delivery",
                        Gender_of_child = "Gender (child)",
                        #Infant_diet = "Infant diet",
                        Gestational_age_at_birth_week = "Gestational age at birth (weeks)",
                        mother_HDP = "Hypertensive disorders of pregnancy (HDP)",
                        mother_Abx.use.post.partum = "Postpartum antibiotic use"),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})"#,
                #all_categorical() ~ "{n} / {N} ({p}%)"
              ),
              digits = all_continuous() ~ 1) %>%
  modify_header(label = "**Gestational Diabetes**") %>%
  add_p() %>%
  add_overall() %>%
  as_gt() %>%
  opt_vertical_padding(scale = 0.25)
  
table1

gtsave(table1, 'table1.docx')
```

# Permanova tests

```{r}
metabolite_infant_t_mx <- t(metabolite_infant_df)
metabolite_infant_t_df <- as.data.frame(metabolite_infant_t_mx)
n_features <- nrow(metabolite_infant_df)
# 1156 x 57
metabolite_infant_t_df$Sample_ID = rownames(metabolite_infant_t_df)

metadata_for_permanova <- metadata_all_df %>%
  select(mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child)
metadata_for_permanova$Sample_ID <- rownames(metadata_for_permanova) 

joint_permanova_df <- left_join(metabolite_infant_t_df, metadata_for_permanova)
rownames(joint_permanova_df) <- joint_permanova_df$Sample_ID

# Only use the samples that were matched with feature data.  Overwrite metadata_for_permanova
metadata_for_permanova <- joint_permanova_df %>%
  select(mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child)

if (all(rownames(metabolite_infant_t_mx) == rownames(joint_permanova_df))) {
  print("Rownames match")
}

metadata_for_permanova.BMI <- joint_permanova_df %>%
  drop_na() %>%
  select(mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child)

metabolite_infant_t_df.BMI <- joint_permanova_df %>%
  drop_na() %>%
  select(-c(mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child, Sample_ID))

if (all(rownames(metadata_for_permanova.BMI) == rownames(metabolite_infant_t_df.BMI))) {
  print("Rownames match")
}

metabolite_infant_t_mx.BMI <- as.matrix(metabolite_infant_t_df.BMI)

adonis_GDM <- adonis2(formula = metabolite_infant_t_mx ~ mother_GDM,
                      data = metadata_for_permanova)
adonis_GDM

adonis_Age <- adonis2(formula = metabolite_infant_t_mx ~ mother_Age.category,
                      data = metadata_for_permanova)
adonis_Age

adonis_Gender <- adonis2(formula = metabolite_infant_t_mx ~ Gender_of_child,
                         data = metadata_for_permanova)
adonis_Gender

adonis_BMI.overweight <- adonis2(formula = metabolite_infant_t_mx.BMI ~ mother_BMI.overweight,
                         data = metadata_for_permanova.BMI)
adonis_BMI.overweight

adonis_BMI.obese <- adonis2(formula = metabolite_infant_t_mx.BMI ~ mother_BMI.obese,
                         data = metadata_for_permanova.BMI)
adonis_BMI.obese

adonis_full_model <- adonis2(formula = metabolite_infant_t_mx.BMI ~ mother_GDM + mother_Age.category + mother_BMI.overweight + mother_BMI.obese + Gender_of_child,
                         data = metadata_for_permanova.BMI)
adonis_full_model
```
# PCA plot

```{r}
# Calculate column standard deviations
col_sds <- apply(metabolite_infant_t_mx, 2, sd)

# Remove columns with 0 sd
metabolite_infant_t_mx_no_constants <- metabolite_infant_t_mx[, -which(col_sds == 0)]

pca1 <- prcomp(metabolite_infant_t_mx_no_constants, center = TRUE, scale = TRUE)
pca1_summary <- summary(pca1)$importance
```

## PCA importance plot
```{r}
pca_importance_df <- data.frame(PC = 1:ncol(pca1_summary), proportion_of_variance = pca1_summary[2,])

pca_importance_df[1:10,] %>%
  ggplot() +
  geom_point(aes(x = PC, y = proportion_of_variance), size = 2) +
  geom_line(aes(x = PC, y = proportion_of_variance), color = 'black') +
  theme_light() +
  ylim(0, 0.15) +
  labs(y = "Proportion of Variance")
```

## PCA plot
```{r}
pca1_data <- as.data.frame(pca1$x)

pca_plot_data <- data.frame(PC1 = pca1_data$PC1, PC2 = pca1_data$PC2, GDM = metadata_for_permanova$mother_GDM)
ggplot(data = pca_plot_data,
       mapping = aes(x = PC1, y = PC2, color = GDM)) +
  geom_point(size = 2.5, alpha = 0.7) +
  # geom_point(size = 2.5, color = 'black', shape = 1) +
  labs(color = "Maternal GDM") +
  theme_light()
```

# Distribution of Y variables
```{r}

mb_long <- as.data.frame(metabolite_infant_t_mx_no_constants) %>%
  #select(-Sample_ID) %>%
  pivot_longer(cols = everything(),
               names_to = "Metabolite")

mb_long %>%
  ggplot() +
  geom_density(aes(x = value, color = Metabolite, fill = Metabolite), alpha = 0.25, linewidth = 0.2) +
  xlim(0, 2) +
  theme(legend.position = "none")
```


# Tweedieverse

```{r}

dir.create('results', showWarnings = FALSE)
```

## Microbiome, univariate mixed model
```{r}
Tweedieverse(input_features = microbiome_infant_df,
             input_metadata = metadata_all_df %>%
               select(mother_GDM, External_ID), 
             fixed_effects = c('mother_GDM'), 
             random_effects = c('External_ID'),
             output = 'results_microbiome_univariate_1_28_Apr2024',
             #prev_threshold = 0,
             #cutoff_ZSCP = 0.1,
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```
## Microbiome, adjusted mixed model w/Age

```{r}
Tweedieverse(input_features = microbiome_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age.category), 
             fixed_effects = c('mother_GDM', 'mother_Age.category'), 
             random_effects = c('External_ID'),
             output = 'results_microbiome_mixed_model_Age_03May2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```
## Microbiome, adjusted mixed model w/BMI

```{r}
Tweedieverse(input_features = microbiome_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_BMI.category), 
             fixed_effects = c('mother_GDM', 'mother_BMI.category'), 
             random_effects = c('External_ID'),
             output = 'results_microbiome_mixed_model_BMI_28Apr2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

## Microbiome, adjusted mixed model w/infant gender

```{r}
Tweedieverse(input_features = microbiome_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age, Gender_of_child), 
             fixed_effects = c('mother_GDM', 'Gender_of_child'), 
             random_effects = c('External_ID'),
             output = 'results_microbiome_mixed_model_gender_28Apr2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

## Microbiome, adjusted mixed model w/Age + BMI + gender of child

```{r}
Tweedieverse(input_features = microbiome_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age.category, mother_BMI.category, Gender_of_child), 
             fixed_effects = c('mother_GDM', 'mother_Age.category', 'mother_BMI.category', 'Gender_of_child'), 
             random_effects = c('External_ID'),
             output = 'results_microbiome_mixed_model_1_03May2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

## Metabolite, univariate mixed model

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(mother_GDM, External_ID),
             fixed_effects = c('mother_GDM'), 
             random_effects = c('External_ID'),
             output = 'results_metabolite_univariate_1_28_Apr2024',
             #prev_threshold = 0,
             #cutoff_ZSCP = 0.1,
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```
## Metabolite, adjusted mixed model w/Age

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age.category), 
             fixed_effects = c('mother_GDM', 'mother_Age.category'),
             random_effects = c('External_ID'),
             output = 'results_metabolite_mixed_model_Age_03May2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```
## Metabolite, adjusted mixed model w/BMI

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_BMI.category), 
             fixed_effects = c('mother_GDM', 'mother_BMI.category'),
             random_effects = c('External_ID'),
             output = 'results_metabolite_mixed_model_BMI_28_Apr2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

## Metabolite, adjusted mixed model w/Gender

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, Gender_of_child), 
             fixed_effects = c('mother_GDM', 'Gender_of_child'),
             random_effects = c('External_ID'),
             output = 'results_metabolite_mixed_model_Gender_28_Apr2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

## Metabolite, adjusted mixed model

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child), 
             fixed_effects = c('mother_GDM', 'mother_Age.category', 'mother_BMI.overweight', 'mother_BMI.obese', 'Gender_of_child'),
             random_effects = c('External_ID'),
             output = 'results_metabolite_mixed_model_1_05May2024',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             link = "log",
             cores = 4)
```
## Metabolite, adjusted mixed model with identity link function

```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(External_ID, mother_GDM, mother_Age.category, mother_BMI.overweight, mother_BMI.obese, Gender_of_child), 
             fixed_effects = c('mother_GDM', 'mother_Age.category', 'mother_BMI.overweight', 'mother_BMI.obese', 'Gender_of_child'),
             random_effects = c('External_ID'),
             output = 'results_metabolite_mixed_model_1_05May2024_identity',
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             link = "identity",
             cores = 5)
```


```{r}
Tweedieverse(input_features = metabolite_infant_df,
             input_metadata = metadata_all_df %>%
               select(mother_GDM, mother_Age, mother_BMI.category), 
             output = 'results_metabolite_univariate_1_28_Apr2024',
             #prev_threshold = 0,
             #cutoff_ZSCP = 0.1,
             plot_scatter = FALSE,
             plot_heatmap = FALSE,
             base_model = "CPLM",
             cores = 4)
```

# Comparing univariate models vs. mixed models

```{r}
significant_results_microbiome_mm_df <- read.delim('results_microbiome_mixed_model_1_28Apr2024/significant_results.tsv')
significant_results_microbiome_uv_df <- read.delim('results_microbiome_univariate_1_28_Apr2024/significant_results.tsv')
all_results_microbiome_mm_df <- read.delim('results_microbiome_mixed_model_1_28Apr2024/all_results.tsv')
all_results_microbiome_uv_df <- read.delim('results_microbiome_univariate_1_28_Apr2024/all_results.tsv')

# mixed model w/log link function

significant_results_metabolite_mm_df <- read.delim('results_metabolite_mixed_model_1_05May2024/significant_results.tsv') 
significant_results_metabolite_mm_df2 <-
  left_join(significant_results_metabolite_mm_df,
            metabolite_name_ref,
            by = c("feature" = "clean_name"))

significant_results_metabolite_mm_df2 <- significant_results_metabolite_mm_df2 %>%
  select(feature = metabolite_name,
         metadata, value, coef, stderr, pval, qval, base.model, tweedie.index, N, N.not.zero, percent.zero)
significant_results_metabolite_mm_df2$metadata <-
  factor(significant_results_metabolite_mm_df2$metadata,
         levels = c("Gender_of_child", "mother_Age.category", "mother_BMI.overweight", "mother_BMI.obese", "mother_GDM"),
         labels = c("Gender", "Age", "BMI_OW", "BMI_OB", "GDM")) 

write.csv(x = significant_results_metabolite_mm_df2,
          file = 'significant_results_metabolite_full_model_05May2024.csv',
          row.names = FALSE)

metabolite_coef_tile_plot <-
significant_results_metabolite_mm_df2 %>%
  ggplot() +
  geom_tile(aes(y = feature, x = metadata, fill = coef),
            color = 'white') +
  scale_fill_distiller(palette = 'Spectral') +
  theme_light() +
  theme(axis.text.y = element_text(size = 7.5),
        axis.text.x = element_text(size = 8)) +
  labs(fill = 'log(coefficient)')

ggsave('sig_metabolite_results.pdf', metabolite_coef_tile_plot,
       height = 20)

# Break plot into 3

tile_plot_wide_df <- significant_results_metabolite_mm_df2 %>%
  select(feature, metadata, coef) %>%
  pivot_wider(names_from = metadata,
              values_from = coef) %>%
  mutate_all( ~replace(., lengths(.)==0, NA)) %>%
  mutate(has_GDM = !is.na(GDM),
         n_vars = as.numeric(!is.na(GDM)) +
           as.numeric(!is.na(Gender)) +
           as.numeric(!is.na(BMI_OW)) +
           as.numeric(!is.na(BMI_OB)) +
           as.numeric(!is.na(Age)),
         group = case_when(has_GDM & n_vars > 1 ~ 1,
                           has_GDM & n_vars == 1 ~ 2,
                           TRUE ~ 3))

tile_plot_long_df <- tile_plot_wide_df %>%
  pivot_longer(cols = c(GDM, Age, Gender, BMI_OW, BMI_OB),
               names_to = 'metadata',
               values_to = 'coef') %>%
  filter(!is.na(coef))

tile_plot_long_df$metadata <- factor(tile_plot_long_df$metadata,
                                     levels = c("GDM", "Gender", "Age", "BMI_OW", "BMI_OB"),
                                     labels = c("GDM", "Gender", "Age", "BMI_OW", "BMI_OB"))

metabolite_coef_tile_plot <- tile_plot_long_df %>%
  filter(group == 1) %>%
  ggplot() +
  geom_tile(aes(y = feature, x = metadata, fill = coef),
            color = 'white') +
  scale_fill_distiller(palette = 'Spectral') +
  theme_light() +
  theme(axis.text.y = element_text(size = 7.5),
        axis.text.x = element_text(size = 7.5)) +
  labs(fill = 'log(coefficient)') 

ggsave('sig_metabolite_results_plot1.pdf', metabolite_coef_tile_plot,
       height = 6)

metabolite_coef_tile_plot <- tile_plot_long_df %>%
  filter(group == 2) %>%
  ggplot() +
  geom_tile(aes(y = feature, x = metadata, fill = coef),
            color = 'white') +
  scale_fill_distiller(palette = 'Spectral') +
  theme_light() +
  theme(axis.text.y = element_text(size = 7.5),
        axis.text.x = element_text(size = 7.5)) +
  labs(fill = 'log(coefficient)') 

ggsave('sig_metabolite_results_plot2.pdf', metabolite_coef_tile_plot,
       height = 18)

metabolite_coef_tile_plot <- tile_plot_long_df %>%
  filter(group == 3) %>%
  ggplot() +
  geom_tile(aes(y = feature, x = metadata, fill = coef),
            color = 'white') +
  scale_fill_distiller(palette = 'Spectral') +
  theme_light() +
  theme(axis.text.y = element_text(size = 7.5),
        axis.text.x = element_text(size = 7.5)) +
  labs(fill = 'log(coefficient)') 

ggsave('sig_metabolite_results_plot3.pdf', metabolite_coef_tile_plot,
       height = 6)

#

significant_results_metabolite_mm_df2_wide <- significant_results_metabolite_mm_df2 %>%
  select(feature, metadata, coef) %>%
  pivot_wider(names_from = metadata,
              values_from = coef)

summary(significant_results_metabolite_mm_df2_wide)
count_sig_results_df <- significant_results_metabolite_mm_df2 %>%
  count(metadata) %>%
  arrange(desc(n))
count_sig_results_df 

# identity link function

significant_results_metabolite_mm_df_id <- read.delim('results_metabolite_mixed_model_1_05May2024_identity/significant_results.tsv') 
significant_results_metabolite_mm_df2_id <-
  left_join(significant_results_metabolite_mm_df_id,
            metabolite_name_ref,
            by = c("feature" = "clean_name"))

significant_results_metabolite_mm_df2_id <- significant_results_metabolite_mm_df2_id %>%
  select(feature = metabolite_name,
         metadata, value, coef, stderr, pval, qval, base.model, tweedie.index, N, N.not.zero, percent.zero)
significant_results_metabolite_mm_df2_id$metadata <-
  factor(significant_results_metabolite_mm_df2_id$metadata,
         levels = c("Gender_of_child", "mother_Age.category", "mother_BMI.overweight", "mother_BMI.obese", "mother_GDM"),
         labels = c("Gender", "Age", "BMI_OW", "BWI_OB", "GDM"))

write.csv(x = significant_results_metabolite_mm_df2_id,
          file = 'significant_results_metabolite_full_model_05May2024_identity.csv',
          row.names = FALSE)

metabolite_coef_tile_plot_id <-
significant_results_metabolite_mm_df2_id %>%
  ggplot() +
  geom_tile(aes(y = feature, x = metadata, fill = coef),
            color = 'white') +
  scale_fill_distiller(palette = 'Spectral') +
  theme(axis.text.y = element_text(size = 7.5)) +
  theme_light()

ggsave('sig_metabolite_results_identity.pdf', metabolite_coef_tile_plot_id,
       height = 20)

mbl_gdm_coef <- significant_results_metabolite_mm_df2 %>%
  #mutate(abs_coef = abs(coef)) %>%
  filter(metadata == 'GDM') %>%
  arrange(desc(coef))
# mbl_bmi_temp <- significant_results_metabolite_mm_df2 %>%
#   #mutate(abs_coef = abs(coef)) %>%
#   filter(metadata == 'mother_BMI.category') %>%
#   arrange(desc(coef))

# TODO: Needs repair - do we need to exponentiate the coef, LL, UL?
gdm_coef_plot <- mbl_gdm_coef %>%
  mutate(e_coef = exp(coef),
         e_ll = exp(coef - 1.96*stderr),
         e_ul = exp(coef + 1.96*stderr)) %>%
  ggplot() + 
  #geom_col(aes(x = coef, y = reorder(feature, coef), fill = coef), width = 0.1) + 
  #geom_point(aes(x = coef, y = reorder(feature, coef), color = coef)) + 
  geom_linerange(aes(xmin = e_ll, xmax = e_ul, y = reorder(feature, e_coef))) + 
  geom_point(aes(x = e_coef, y = reorder(feature, e_coef)), color = 'black', shape = 1, show.legend = FALSE) + 
  theme_light() + 
  theme(axis.text.y = element_text(size = 6.5)) +
  labs(y = 'Metabolite', x = 'coefficient') +
  geom_vline(xintercept = 1, color = 'red', linetype = 'dashed') +
  scale_x_log10(labels = scales::label_number())
  
ggsave(plot = gdm_coef_plot, filename = 'gdm_coef_plot_05May2024.pdf', height = 14, width = 8.5)

significant_results_metabolite_uv_df <- read.delim('results_metabolite_univariate_1_28_Apr2024/significant_results.tsv')
all_results_metabolite_mm_df <- read.delim('results_metabolite_mixed_model_1_28Apr2024/all_results.tsv')
all_results_metabolite_uv_df <- read.delim('results_metabolite_univariate_1_28_Apr2024/all_results.tsv')
```

# Comparing univariate and multivariate effect sizes

## Metabolite

```{r}
results_compare_metabolite <- left_join(significant_results_metabolite_uv_df,
                                        all_results_metabolite_mm_df,
                                        by = c('feature', 'metadata', 'value'),
                                        suffix = c('.uv', '.mm')) %>%
  mutate(metadata_value = paste(metadata, '=', value))
results_compare_microbiome <- left_join(significant_results_microbiome_uv_df,
                                        all_results_microbiome_mm_df,
                                        by = c('feature', 'metadata', 'value'),
                                        suffix = c('.uv', '.mm')) %>%
  mutate(metadata_value = paste(metadata, '=', value))
```

## Microbiome

```{r}
rcmcb <- results_compare_microbiome %>%
  ggplot() +
  geom_point(aes(y = feature,
                 x = coef.uv),
             color = 'blue',
             position = position_nudge(y = 0.1)) +
  geom_linerange(aes(y = feature,
                     xmin = coef.uv - 1.96*stderr.uv,
                     xmax = coef.uv + 1.96*stderr.uv),
                 color = 'blue',
             position = position_nudge(y = 0.1)) +
  geom_point(aes(y = feature,
                 x = coef.mm,
                 color = pval.mm >= 0.05),
             position = position_nudge(y = -0.1)) +
  geom_linerange(aes(y = feature,
                     xmin = coef.mm - 1.96*stderr.mm,
                     xmax = coef.mm + 1.96*stderr.mm,
                 color = pval.mm >= 0.05),
             position = position_nudge(y = -0.1)) +
  geom_vline(xintercept = 0, linetype = 'dashed') +
  scale_colour_manual(values = c('FALSE' = "green", 'TRUE' = "red")) +
    theme(legend.position = "none") + 
  facet_wrap(~ metadata_value, ncol = 1,
             scales = 'free')

rcmcb 
ggsave('rcmcb.pdf', rcmcb, width = 8, height = 6)
```

# Visualizations for comparisons

## Metabolite forest plot

```{r}
rcmtb <- results_compare_metabolite %>%
  ggplot() +
  # univariate: blue
  geom_point(aes(y = reorder(feature, coef.uv, decreasing = FALSE),
                 x = coef.uv),
             color = 'blue',
             position = position_nudge(y = 0.1)) +
  geom_linerange(aes(y = reorder(feature, coef.uv, decreasing = FALSE),
                     xmin = coef.uv - 1.96*stderr.uv,
                     xmax = coef.uv + 1.96*stderr.uv),
                 color = 'blue',
             position = position_nudge(y = 0.1)) +
  # multivariate: red if p value is now non-significant; green if still significant
  geom_point(aes(y = reorder(feature, coef.uv, decreasing = FALSE),
                 x = coef.mm,
                 color = pval.mm >= 0.05),
             position = position_nudge(y = -0.1)) +
  geom_linerange(aes(y = reorder(feature, coef.uv, decreasing = FALSE),
                     xmin = coef.mm - 1.96*stderr.mm,
                     xmax = coef.mm + 1.96*stderr.mm,
                     color = pval.mm >= 0.05),
             position = position_nudge(y = -0.1)) +
  geom_vline(xintercept = 0, linetype = 'dashed') +
  facet_wrap(~ metadata_value, ncol = 1,
             scales = 'free') +
  scale_colour_manual(values = c('FALSE' = "green", 'TRUE' = "red")) +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 5))
rcmtb
ggsave('rcmtb.pdf', rcm, width = 8, height = 60, limitsize = FALSE)

```

## Metabolite Scatter (?) plot

```{r}
plot_metabolite_uv_mm <- results_compare_metabolite %>%
  ggplot() +
  geom_point(aes(x = coef.uv, y = coef.mm), shape = 1) +
#  geom_text(aes(x = coef.uv, y = coef.mm, label = feature), nudge_y = 2) + 
  geom_abline(intercept = 0, slope = 1) + 
  ylim(-6, 70) +
  xlim(-6, 70)

plot_metabolite_uv_mm

ggsave(filename = "metabolite_uv_vs_mm.pdf", plot_metabolite_uv_mm, height = 6, width = 6)
```
## Microbiome Scatter (?) plot

```{r}
results_compare_microbiome %>%
  ggplot() +
  geom_point(aes(x = coef.uv, y = coef.mm)) +
#  geom_text(aes(x = coef.uv, y = coef.mm, label = feature), nudge_y = 2) + 
  geom_abline(intercept = 0, slope = 1)# + 
 # ylim(-6, 70) +
#  xlim(-6, 70)
```


# Alpha diversity 

## Microbiome - Infant 

```{r}
microbiome_infant_t_df <- t(microbiome_infant_df)
infant_id <- gsub(".*?([0-9]+).*", "\\1", rownames(microbiome_infant_t_df))
infant_id <- sprintf('X%02d', as.numeric(infant_id))
sample_diversity <- diversity(microbiome_infant_t_df, index = "shannon", groups = infant_id)
sample_diversity_df <- data.frame(sample_diversity, Sample_ID = names(sample_diversity))


# Get mother metadata for each infant_id
alpha_analysis_df <- data.frame(Sample_ID = sprintf('X%02d', metadata_mother_df$External_ID),
                                mother_GDM = metadata_mother_df$mother_GDM,
                                mother_BMI.category = metadata_mother_df$mother_BMI.category,
                                mother_BMI = metadata_mother_df$mother_BMI,
                                mother_Age = metadata_mother_df$mother_Age)

alpha_analysis_df <- left_join(alpha_analysis_df, sample_diversity_df)

alpha_analysis_df %>%
  ggplot() +
  geom_density(aes(x = sample_diversity),
               color = 'blue',
               fill = 'blue',
               alpha = 0.2)

alpha_analysis_df %>%
  ggplot() +
  geom_point(aes(x = mother_BMI,
                 y = sample_diversity,
                 color = mother_GDM)) +
  geom_smooth(aes(x = mother_BMI,
                 y = sample_diversity),
              method = "lm")
  
alpha_model_multivariate <- lm(sample_diversity ~ mother_BMI + mother_Age + mother_GDM,
                      data = alpha_analysis_df)
summary(alpha_model_multivariate)

alpha_model_GDM <- lm(sample_diversity ~ mother_GDM,
                      data = alpha_analysis_df)
summary(alpha_model_GDM)

alpha_model_BMI <- lm(sample_diversity ~ mother_BMI,
                      data = alpha_analysis_df)
summary(alpha_model_BMI)

alpha_model_BMI <- lm(sample_diversity ~ mother_BMI,
                      data = alpha_analysis_df)
summary(alpha_model_BMI)
```
## Microbiome - Mother 

```{r}
microbiome_mother_t_df <- t(microbiome_mother_df)
mother_id <- gsub(".*?([0-9]+).*", "\\1", rownames(microbiome_mother_t_df))
mother_id <- sprintf('X%02d', as.numeric(mother_id))
sample_diversity <- diversity(microbiome_mother_t_df, index = "shannon", groups = mother_id)
sample_diversity_df <- data.frame(sample_diversity, Sample_ID = names(sample_diversity))


# Get mother metadata for each infant_id
alpha_analysis_df <- data.frame(Sample_ID = sprintf('X%02d', metadata_mother_df$External_ID),
                                mother_GDM = metadata_mother_df$mother_GDM,
                                mother_BMI.category = metadata_mother_df$mother_BMI.category,
                                mother_BMI = metadata_mother_df$mother_BMI,
                                mother_Age = metadata_mother_df$mother_Age)

alpha_analysis_df <- left_join(alpha_analysis_df, sample_diversity_df)

alpha_analysis_df %>%
  ggplot() +
  geom_density(aes(x = sample_diversity),
               color = 'blue',
               fill = 'blue',
               alpha = 0.2)

alpha_analysis_df %>%
  ggplot() +
  geom_point(aes(x = mother_BMI,
                 y = sample_diversity,
                 color = mother_GDM)) +
  geom_smooth(aes(x = mother_BMI,
                 y = sample_diversity),
              method = "lm")
  
alpha_model_multivariate <- lm(sample_diversity ~ mother_BMI + mother_Age + mother_GDM,
                      data = alpha_analysis_df)
summary(alpha_model_multivariate)

# does not match paper
alpha_model_GDM <- lm(sample_diversity ~ mother_GDM,
                      data = alpha_analysis_df)
summary(alpha_model_GDM)
# 0.303 -> -log(0.303) = 1.19

alpha_model_BMI <- lm(sample_diversity ~ mother_BMI,
                      data = alpha_analysis_df)
summary(alpha_model_BMI)
BMI_pval <- summary(alpha_model_BMI)$coefficients[2, 4]
-log(BMI_pval)

alpha_model_BMI.category <- lm(sample_diversity ~ factor(mother_BMI.category, ordered = TRUE),
                      data = alpha_analysis_df)
summary(alpha_model_BMI.category)
BMI.category_pval <- summary(alpha_model_BMI)$coefficients[2, 4]
-log(BMI_pval)
```




```{r}
#if(!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("Maaslin2")
```

```{r}
library(Maaslin2)
# 
metabolite_tsv_filename = 'metabolite_df.tsv'
# metadata_tsv_filename = 'metadata_df.tsv'
# write.table(metabolite_df, file=metabolite_tsv_filename, sep='\t')
# write.table(metadata_df, file=metadata_tsv_filename, sep='\t')
# 
# fit_data = Maaslin2(
#     input_data = metabolite_tsv_filename, 
#     input_metadata = metadata_tsv_filename, 
#     output = "results")# , 
#   #  fixed_effects = c("diagnosis", "dysbiosis"))
```

